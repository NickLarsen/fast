<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- https://stackoverflow.com/a/24511232/178082 -->
    <title>Add Marker to Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script>
        var map;
        function initialize() {
            var mapOptions = {
                zoom: 12,
                // TODO: pull this so we dont have to check it each time
                //center: new google.maps.LatLng(-12.052618892946983,-77.0599418376168) // Lima, Peru
                //center: new google.maps.LatLng(55.8558197,-4.2978574) // Glasgow, UK
                center: new google.maps.LatLng(40.7592678,-74.0251393) // New York, USA
            };
            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
            // https://stackoverflow.com/a/8026984/178082
            var pointFrom, pointTo;
            google.maps.event.addListener(map, 'click', function( event ){
                console.log( "" + event.latLng.lat()+","+event.latLng.lng() ); 
                pointFrom = pointTo;
                pointTo = event.latLng;
                if (pointFrom) {
                    getDirections(pointFrom, pointTo);
                }
            });
            getLandmarks();
        }
        google.maps.event.addDomListener(window, 'load', initialize);
        function addMarker(lat, lon) {
            var marker = new google.maps.Marker({
                position: new google.maps.LatLng(lat,lon)
            });
            marker.setMap(map);
        }
        //https://developers.google.com/maps/documentation/javascript/shapes
        function addLineSegment(lat1, lon1, lat2, lon2) {
            var points = [
                {lat: lat1, lng: lon1},
                {lat: lat2, lng: lon2}
            ];
            var lineSegment = new google.maps.Polyline({
                path: points,
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2
            });
            lineSegment.setMap(map);
        }
        var currentPath = null;
        function showResultsSegment(points) {
            if (currentPath != null) {
                currentPath.setMap(null);
            }
            currentPath = new google.maps.Polyline({
                path: points,
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2
            });
            currentPath.setMap(map);
        }
        function getDirections(pointFrom, pointTo) {
            var query = "latFrom=" + pointFrom.lat() + "&lonFrom=" + pointFrom.lng() +
                        "&latTo=" + pointTo.lat() + "&lonTo=" + pointTo.lng();
            fetch("/api/map/directions?" + query)
                .then(function(response) {
                    if (response.ok)
                    {
                        return response.json();
                    }
                    console.log(response);
                })
                .then(data => {
                    console.log("locations: " + data.problemDefineTime + ", solve: " + data.directionsFindTime);
                    showResultsSegment(data.points);
                });
        }
        function getLandmarks() {
            fetch("/api/map/get-landmarks")
                .then(function(response) {
                    if (response.ok)
                    {
                        return response.json();
                    }
                    console.log(response);
                })
                .then(data => {
                    console.log("landmarks:");
                    console.log(data);
                    for(let i in data) {
                        const l = data[i];
                        const marker = new google.maps.Marker({position: l});
                        marker.setMap(map);
                    }
                });
        }
    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
  </body>
</html>